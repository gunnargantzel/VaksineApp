<!doctype html>
<html lang="nb-NO">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VaksineApp - Vaksinasjonsadministrasjon</title>
    <meta name="description" content="Moderne vaksinasjonsadministrasjonssystem med Entra ID og DataVerse" />
    <!-- MSAL.js CDN with fallback -->
    <script>
      // Load MSAL with fallback
      function loadMSAL() {
        const script = document.createElement('script');
        script.src = 'https://alcdn.msauth.net/browser/2.20.0/js/msal-browser.min.js';
        script.onload = function() {
          console.log('MSAL loaded successfully');
          console.log('MSAL available:', typeof window.msal);
          if (window.msal) {
            console.log('MSAL PublicClientApplication available:', !!window.msal.PublicClientApplication);
          }
        };
        script.onerror = function() {
          console.error('Failed to load MSAL from primary CDN, trying fallback...');
          // Try fallback CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://unpkg.com/@azure/msal-browser@2.20.0/dist/msal-browser.min.js';
          fallbackScript.onload = function() {
            console.log('MSAL loaded from fallback CDN');
          };
          fallbackScript.onerror = function() {
            console.error('Failed to load MSAL from both CDNs');
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      }
      
      // MSAL will be loaded after fetch polyfill is ready
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Comprehensive polyfills for browser compatibility
      if (typeof global === 'undefined') {
        window.global = window;
      }
      if (typeof process === 'undefined') {
        window.process = { 
          env: {}, 
          platform: 'browser', 
          version: 'v16.0.0',
          browser: true,
          nextTick: (fn) => setTimeout(fn, 0)
        };
      }
      if (typeof Buffer === 'undefined') {
        window.Buffer = { isBuffer: () => false };
      }
      if (typeof require === 'undefined') {
        window.require = () => {};
      }
      
      // Create a custom fetch wrapper to prevent MSAL fetch.js errors
      console.log('Creating custom fetch wrapper...');
      
      // Store original fetch if it exists
      const originalFetch = window.fetch;
      
      // Create a custom fetch that handles Request properly
      window.fetch = function(input, init) {
        try {
          // Ensure Request is properly defined
          if (typeof Request === 'undefined') {
            console.log('Request not available, using fallback...');
            // Simple fallback for Request
            if (typeof input === 'string') {
              return originalFetch ? originalFetch(input, init) : Promise.reject(new Error('No fetch available'));
            }
          }
          
          // Use original fetch if available
          if (originalFetch) {
            return originalFetch(input, init);
          }
          
          // Fallback to XMLHttpRequest if no fetch
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open(init?.method || 'GET', input);
            xhr.onload = () => resolve({
              ok: xhr.status >= 200 && xhr.status < 300,
              status: xhr.status,
              text: () => Promise.resolve(xhr.responseText),
              json: () => Promise.resolve(JSON.parse(xhr.responseText))
            });
            xhr.onerror = () => reject(new Error('Network error'));
            xhr.send(init?.body);
          });
        } catch (error) {
          console.error('Custom fetch error:', error);
          return Promise.reject(error);
        }
      };
      
      // Load fetch polyfill first, before MSAL
      console.log('Loading fetch polyfill...');
      const fetchScript = document.createElement('script');
      fetchScript.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js';
      fetchScript.onload = function() {
        console.log('Fetch polyfill loaded successfully');
        // Now load MSAL after fetch is available
        loadMSAL();
      };
      fetchScript.onerror = function() {
        console.error('Failed to load fetch polyfill, trying alternative...');
        // Try alternative fetch polyfill
        const altFetchScript = document.createElement('script');
        altFetchScript.src = 'https://unpkg.com/whatwg-fetch@3.6.2/dist/fetch.umd.js';
        altFetchScript.onload = function() {
          console.log('Alternative fetch polyfill loaded');
          loadMSAL();
        };
        altFetchScript.onerror = function() {
          console.error('All fetch polyfills failed, loading MSAL anyway...');
          loadMSAL();
        };
        document.head.appendChild(altFetchScript);
      };
      document.head.appendChild(fetchScript);
      
      // Ensure Request is available
      if (typeof Request === 'undefined' && typeof window.Request === 'undefined') {
        console.log('Request not available, creating polyfill...');
        window.Request = function() {
          throw new Error('Request polyfill not fully implemented');
        };
      }
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
